#!/usr/bin/env node
(()=>{"use strict";var e={146:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var s=Object.getOwnPropertyDescriptor(t,n);s&&!("get"in s?!t.__esModule:s.writable||s.configurable)||(s={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,s)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return s(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildFont=void 0;const l=a(n(282)),i=a(n(17)),c=r(n(147)),u=a(n(714)),f=a(n(61)),d=a(n(484)),m=a(n(356)),p=n(163),g=n(231),h=a(n(81)),y=a(n(387));async function x(e,t,n,o){try{const s=await(0,f.default)(t,o,{targetFormat:"woff2"});await c.default.promises.writeFile(i.default.join(e,n),s),console.log("ok:",n,s.length,"bytes")}catch(e){console.log("Error:",n,e)}}async function j(e,t,n,o,s,r,a){console.log("BUILD CHUNK:",o);const u=function(e){const t=[];let n={start:-1,count:0};for(let o=0;o<e.length;o++){let s=e.charCodeAt(o);s!=n.start+n.count?(n.start>=0&&t.push({start:n.start,count:n.count}),n.start=s,n.count=1):n.count++}t.push({start:n.start,count:n.count});const o=t.reduce(((e,t)=>e+t.count),0);return console.log("charsString length",e.length),console.log("char span count",t.length),console.log("calced chars count",o),t}(s);let f=0,d=[],m=[];for(let e of u){let t=0;for(;;){let n=e.count-t;if(!(f+n>=r)){d.push({start:e.start+t,count:n}),f+=n;break}{let n=r-f;d.push({start:e.start+t,count:n}),f+=n,m.push(d),t+=n,f=0,d=[]}}}d.length>0&&(d.reduce(((e,t)=>e+t.count),0)<r/2?m[m.length-1].push(...d):m.push(d));let p="";for(let s of m){let r=s.reduce(((e,t)=>e+t.count),0);const a=`${o}_${s[0].start.toString(16)}_${r}`;console.log("chunk:",a);const u=`${a}.woff2`,f=s.reduce(((e,t)=>{for(let n=0;n<t.count;n++)e.push(String.fromCharCode(t.start+n));return e}),[]).join("");console.log(f),await x(e,n,u,f);try{const t=(await c.default.promises.stat(i.default.join(e,u))).size;console.log("write OK",u,t)}catch(e){console.log("error:",e.message),l.default.exit(1)}const d=s.map((e=>e.count>1?`U+${e.start.toString(16)}-${(e.start+e.count).toString(16)}`:`U+${e.start.toString(16)}`)).join(",").toUpperCase();p+=`@font-face {font-family: '${t.familyName}';src: local('${t.familyName}'), url('${u}');unicode-range: ${d};}\n`}return p}async function v(e,t,n,o,s,r){g.FontLibrary.use(o.familyName,[e]);const a=new g.Canvas(100,100).getContext("2d");let l=s.map((e=>(a.font=`${e.size}px "${o.familyName}"`,{...e,...a.measureText(e.text)}))),c=Math.max(...l.map((e=>e.width))),u=l.reduce(((e,t)=>e+t.fontBoundingBoxAscent+t.fontBoundingBoxDescent+10),0);console.log("width:",c,"height:",u);let f=new g.Canvas(c+20,u+20);const d=f.getContext("2d");let m=10;for(let e of l){d.font=`${e.size}px "${o.familyName}"`,d.fillStyle="rgb(0,0,0)";let t=10+(c-e.width)/2,n=m+e.fontBoundingBoxAscent;d.fillText(e.text,t,n),m+=e.fontBoundingBoxAscent+e.fontBoundingBoxDescent+10}f.saveAsSync(i.default.join(t,r),{format:"png"})}function w(e){return JSON.parse(c.default.readFileSync(i.default.join(__dirname,e),"utf8"))}t.buildFont=async function(e,t){console.log(`---- font file: ${t} ----`);let n=u.default.parse(await c.promises.readFile(i.default.join(e,"font.json5"),"utf8"));console.log("  ==> ",n.name);let o=i.default.join(e,t),s=m.default.openSync(o);if(!s)throw Error("open font failed: "+t);console.log("  ==> ",s.familyName,",",s.subfamilyName,",",s.fullName,",",s.numGlyphs),n.fontPkgName=`cn-fontsource-${(0,d.default)(s.familyName+"-"+s.subfamilyName+(n.ext?"-"+n.ext:""))}`,await async function(e,t){let n=await y.default.get(`https://registry.npmjs.com/${e}`,{responseType:"json",validateStatus:e=>e<500});if(404!=n.status&&n.data.versions[t])throw Error(`Npm existd ${e}, ${t},please upgrade version or change name`)}(n.fontPkgName,n.version);let r=i.default.resolve("./tmp",n.name,n.fontPkgName);c.default.existsSync(r)&&c.default.rmSync(r,{recursive:!0}),c.default.mkdirSync(r,{recursive:!0}),console.log("  OUTPUT: ==> ",r);let a=await c.promises.readFile(o),l=(0,p.makeHZ)(s),f="";f+=await j(r,s,a,"L1",l.L1,192),f+=await j(r,s,a,"L2",l.L2,96),f+=await j(r,s,a,"L3",l.L3,64),console.log(`  END ==>  ${t} \n`),c.default.writeFileSync(i.default.join(r,"font.css"),f,"utf8"),await v(o,r,0,s,[{size:48,text:n.name}],"font.png");let g=[...w("sc0.json"),...w("sc1.json"),...w("sc2.json"),...w("sc3.json"),...w("sc4.json"),...w("sc5.json"),...w("sc6.json"),...w("sc7.json"),...w("sc8.json"),...w("sc9.json"),...w("sc10.json")],x=Math.round(Math.random()*g.length);await v(o,r,0,s,[{size:48,text:g[x].rhythmic},{size:24,text:g[x].author},...g[x].paragraphs.map((e=>({size:32,text:e})))],"demo.png"),await async function(e,t,n){const o={name:t.fontPkgName,description:t.description,version:t.version,repository:"https://github.com/wc-ex/cn-fontsource",keywords:["cn","cnfont","cn-font","fontsource",t.name],font:{name:t.name,type:t.type,fontClass:t.fontClass,link:t.link,version:n.version,familyName:n.familyName,subfamilyName:n.subfamilyName,copyright:n.copyright,characterCount:n.characterSet.length},license:t.license};c.default.writeFileSync(i.default.join(e,"package.json"),JSON.stringify(o,null,2))}(r,n,s),await async function(e,t,n){const o=`![${t.name}](https://cdn.jsdelivr.net/npm/${t.fontPkgName}@${t.version}/font.png)\n\n### ${{free:"非开源,免费商用",opensource:"开源字体-推荐使用",paid:"商业字体"}[t.type]||"商业或未知"}\n> LICENSE: ${t.license}\n\n适用于浏览器的多片段快速加载的中文字库\n- ${t.description}\n- 参见:  ${t.link}\n- 更多字体: WEB在线中文字体搜集:  https://github.com/wc-ex/cn-fontsource\n\n![demo](https://cdn.jsdelivr.net/npm/${t.fontPkgName}@${t.version}/demo.png)\n\n### 信息\n- version: ${n.version}\n- familyName: ${n.familyName}\n- subfamilyName: ${n.subfamilyName}\n- fullName: ${JSON.stringify(n.fullName)}\n- characterCount: ${n.characterSet.length}\n\n### 使用\n- CDN 直接调用\n  \`\`\`html\n  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/${t.fontPkgName}/font.css"></link>\n  <style>\n    html{\n      font-family: Roboto, "${n.familyName}", sans-serif;\n    }\n  </style>\n  \`\`\`\n- 本地化\n  > npm i ${t.fontPkgName}\n\n  > 加载: font.css\n\n`;c.default.writeFileSync(i.default.join(e,"README.md"),o)}(r,n,s),console.log("  ==> SUCCEED BUILD"),h.default.execSync('npm --registry "https://registry.npmjs.org/" publish --access public',{cwd:r,stdio:"inherit"}),console.log("== SUCCEED PUBLISH NPM == ")}},163:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.makeHZ=void 0;const s=o(n(147)),r=o(n(17));function a(e){const t=[],n=new Set;let o=0;for(let s of e)n.has(s)?o++:(t.push(s),n.add(s));return console.log("  ==> dup chars:",o),t.sort().join("")}function l(e,t){const n=[],o=new Set;for(let t of e)o.add(t);for(let e of t)o.has(e)||(n.push(e),o.add(e));return n.sort().join("")}t.makeHZ=function(e){let t="",n="";t=s.default.readFileSync(r.default.join(__dirname,"./L1.txt"),"utf8").replace(/\s/g,""),n=s.default.readFileSync(r.default.join(__dirname,"./L2.txt"),"utf8").replace(/\s/g,"");const o=a(t);console.log("  ==> L1: org=",t.length,"dedup=",o.length);const i=l(o,n);console.log("  ==> L2: org=",n.length,"dedup=",i.length);const c=a(String.fromCharCode(...e.characterSet.sort())),u=l(t+n,c).replace(/[\x00-\x1f]/g,"");return console.log("  ==> L3:",u.length),console.log("  ==> ALL=",c.length),{L1:o,L2:i,L3:u}}},872:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=o(n(282)),r=o(n(17)),a=n(147),l=n(146);3!==s.default.argv.length&&(console.log("Invalid args\nUsage: cn-fontsource [fontDir]"),s.default.exit(0));let i=r.default.resolve(s.default.argv[2]);console.log(`=== build web font : ${i} ===\n`),(async()=>{try{let e=(await a.promises.readdir(i)).filter((e=>e.endsWith("ttf")||e.endsWith("otf")));for(let t of e)await(0,l.buildFont)(i,t)}catch(e){console.log("Error:",e.message)}})()},387:e=>{e.exports=require("axios")},356:e=>{e.exports=require("fontkit")},714:e=>{e.exports=require("json5")},484:e=>{e.exports=require("lodash.kebabcase")},231:e=>{e.exports=require("skia-canvas")},61:e=>{e.exports=require("subset-font")},81:e=>{e.exports=require("child_process")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")},282:e=>{e.exports=require("process")}},t={};!function n(o){var s=t[o];if(void 0!==s)return s.exports;var r=t[o]={exports:{}};return e[o].call(r.exports,r,r.exports,n),r.exports}(872)})();